<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PojoEntityManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Terasology$engine_tests_with_JaCoCo.exec</a> &gt; <a href="index.source.html" class="el_package">org.terasology.entitySystem.entity.internal</a> &gt; <span class="el_source">PojoEntityManager.java</span></div><h1>PojoEntityManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017 MovingBlocks
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.terasology.entitySystem.entity.internal;

import com.google.common.base.Preconditions;
import com.google.common.collect.Iterables;
import com.google.common.collect.Lists;
import com.google.common.collect.MapMaker;
import com.google.common.collect.Maps;
import com.google.common.collect.Sets;
import gnu.trove.iterator.TLongObjectIterator;
import gnu.trove.set.TLongSet;
import gnu.trove.set.hash.TLongHashSet;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.terasology.engine.TerasologyConstants;
import org.terasology.entitySystem.Component;
import org.terasology.entitySystem.entity.EntityBuilder;
import org.terasology.entitySystem.entity.EntityRef;
import org.terasology.entitySystem.entity.lifecycleEvents.BeforeDeactivateComponent;
import org.terasology.entitySystem.entity.lifecycleEvents.BeforeRemoveComponent;
import org.terasology.entitySystem.entity.lifecycleEvents.OnActivatedComponent;
import org.terasology.entitySystem.entity.lifecycleEvents.OnAddedComponent;
import org.terasology.entitySystem.entity.lifecycleEvents.OnChangedComponent;
import org.terasology.entitySystem.event.internal.EventSystem;
import org.terasology.entitySystem.metadata.ComponentLibrary;
import org.terasology.entitySystem.prefab.Prefab;
import org.terasology.entitySystem.prefab.PrefabManager;
import org.terasology.entitySystem.sectors.SectorSimulationComponent;
import org.terasology.game.GameManifest;
import org.terasology.math.geom.Quat4f;
import org.terasology.math.geom.Vector3f;
import org.terasology.persistence.typeHandling.TypeHandlerLibrary;
import org.terasology.world.internal.WorldInfo;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;

import static org.terasology.entitySystem.entity.internal.EntityScope.SECTOR;

<span class="fc" id="L60">public class PojoEntityManager implements EngineEntityManager {</span>
    public static final long NULL_ID = 0;

<span class="fc" id="L63">    private static final Logger logger = LoggerFactory.getLogger(PojoEntityManager.class);</span>

<span class="fc" id="L65">    private long nextEntityId = 1;</span>
<span class="fc" id="L66">    private TLongSet loadedIds = new TLongHashSet();</span>

<span class="fc" id="L68">    private EngineEntityPool globalPool = new PojoEntityPool(this);</span>
<span class="fc" id="L69">    private PojoSectorManager sectorManager = new PojoSectorManager(this);</span>
<span class="fc" id="L70">    private Map&lt;Long, EngineEntityPool&gt; poolMap = new MapMaker().initialCapacity(1000).makeMap();</span>
<span class="fc" id="L71">    private List&lt;EngineEntityPool&gt; worldPools = Lists.newArrayList();</span>
<span class="fc" id="L72">    private Map&lt;EngineEntityPool, Long&gt; poolCounts = new HashMap&lt;EngineEntityPool, Long&gt;();</span>

<span class="fc" id="L74">    private Set&lt;EntityChangeSubscriber&gt; subscribers = Sets.newLinkedHashSet();</span>
<span class="fc" id="L75">    private Set&lt;EntityDestroySubscriber&gt; destroySubscribers = Sets.newLinkedHashSet();</span>
    private EventSystem eventSystem;
    private PrefabManager prefabManager;
    private ComponentLibrary componentLibrary;
    private WorldManager worldManager;
    private GameManifest gameManifest;

<span class="fc" id="L82">    private RefStrategy refStrategy = new DefaultRefStrategy();</span>

    private TypeHandlerLibrary typeSerializerLibrary;

    @Override
    public RefStrategy getEntityRefStrategy() {
<span class="fc" id="L88">        return refStrategy;</span>
    }

    @Override
    public void setEntityRefStrategy(RefStrategy strategy) {
<span class="nc" id="L93">        this.refStrategy = strategy;</span>
<span class="nc" id="L94">    }</span>

    @Override
    public EngineEntityPool getGlobalPool() {
<span class="fc" id="L98">        return globalPool;</span>
    }

    /**
     * Check if world pools have been created and returns them such that subsequent entities are put in them. The global pool
     * is returned if no world pools have been created.
     *
     * @return the pool under consideration.
     */
    public EngineEntityPool getCurrentWorldPool() {
<span class="pc bpc" id="L108" title="3 of 4 branches missed.">        if (worldManager == null || worldManager.getCurrentWorldPool() == null) {</span>
<span class="fc" id="L109">            return globalPool;</span>
        } else {
<span class="nc" id="L111">            return worldManager.getCurrentWorldPool();</span>
        }
    }

    /**
     * Not all entities are present in the world pools. The world pools are created only
     * in the {@link org.terasology.engine.modes.loadProcesses.CreateWorldEntity} process, but much before
     * that some blocks are loaded. Hence those are by default put into the global pool.
     *
     * @return if world pools have been formed or not
     */
    private boolean isWorldPoolGlobalPool() {
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        return getCurrentWorldPool() == globalPool;</span>
    }

    @Override
    public void clear() {
<span class="fc" id="L128">        globalPool.clear();</span>
<span class="fc" id="L129">        sectorManager.clear();</span>
<span class="fc" id="L130">        nextEntityId = 1;</span>
<span class="fc" id="L131">        loadedIds.clear();</span>
<span class="fc" id="L132">    }</span>

    @Override
    public EntityBuilder newBuilder() {
<span class="fc" id="L136">        return getCurrentWorldPool().newBuilder();</span>
    }

    @Override
    public EntityBuilder newBuilder(String prefabName) {
<span class="nc" id="L141">        return getCurrentWorldPool().newBuilder(prefabName);</span>
    }

    @Override
    public EntityBuilder newBuilder(Prefab prefab) {
<span class="fc" id="L146">        return getCurrentWorldPool().newBuilder(prefab);</span>
    }

    @Override
    public EntityRef create() {
<span class="fc" id="L151">        return getCurrentWorldPool().create();</span>
    }

    @Override
    public void createWorldPools(GameManifest game) {
<span class="nc" id="L156">        this.gameManifest = game;</span>
<span class="nc" id="L157">        Map&lt;String, WorldInfo&gt; worldInfoMap = gameManifest.getWorldInfoMap();</span>
<span class="nc" id="L158">        worldManager = new WorldManager(gameManifest.getWorldInfo(TerasologyConstants.MAIN_WORLD));</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        for (Map.Entry&lt;String, WorldInfo&gt; worldInfoEntry : worldInfoMap.entrySet()) {</span>
<span class="nc" id="L160">            EngineEntityPool pool = new PojoEntityPool(this);</span>
            //pool.create();
<span class="nc" id="L162">            worldPools.add(pool);</span>
<span class="nc" id="L163">            worldManager.addWorldPool(worldInfoEntry.getValue(), pool);</span>
<span class="nc" id="L164">        }</span>
<span class="nc" id="L165">    }</span>

    @Override
    public EntityRef createSectorEntity(long maxDelta) {
<span class="nc" id="L169">        return createSectorEntity(maxDelta, maxDelta);</span>
    }

    @Override
    public EntityRef createSectorEntity(long unloadedMaxDelta, long loadedMaxDelta) {
<span class="nc" id="L174">        EntityRef entity = sectorManager.create();</span>
<span class="nc" id="L175">        entity.setScope(SECTOR);</span>

<span class="nc" id="L177">        SectorSimulationComponent simulationComponent = entity.getComponent(SectorSimulationComponent.class);</span>
<span class="nc" id="L178">        simulationComponent.unloadedMaxDelta = unloadedMaxDelta;</span>
<span class="nc" id="L179">        simulationComponent.loadedMaxDelta = loadedMaxDelta;</span>
<span class="nc" id="L180">        entity.saveComponent(simulationComponent);</span>

<span class="nc" id="L182">        return entity;</span>
    }

    @Override
    public long createEntity() {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (nextEntityId == NULL_ID) {</span>
<span class="nc" id="L188">            nextEntityId++;</span>
        }
<span class="fc" id="L190">        loadedIds.add(nextEntityId);</span>
<span class="fc" id="L191">        return nextEntityId++;</span>
    }

    @Override
    public EntityRef create(Component... components) {
<span class="fc" id="L196">        return getCurrentWorldPool().create(components);</span>
    }

    @Override
    public EntityRef create(Iterable&lt;Component&gt; components) {
<span class="nc" id="L201">        return getCurrentWorldPool().create(components);</span>
    }

    @Override
    public EntityRef create(Iterable&lt;Component&gt; components, boolean sendLifecycleEvents) {
<span class="nc" id="L206">        return getCurrentWorldPool().create(components, sendLifecycleEvents);</span>
    }

    @Override
    public EntityRef create(String prefabName) {
<span class="fc" id="L211">        return getCurrentWorldPool().create(prefabName);</span>
    }

    @Override
    public EntityRef create(Prefab prefab, Vector3f position) {
<span class="nc" id="L216">        return getCurrentWorldPool().create(prefab, position);</span>
    }

    @Override
    public EntityRef create(Prefab prefab, Vector3f position, Quat4f rotation) {
<span class="nc" id="L221">        return getCurrentWorldPool().create(prefab, position, rotation);</span>
    }

    @Override
    public EntityRef create(String prefab, Vector3f position) {
<span class="nc" id="L226">        return getCurrentWorldPool().create(prefab, position);</span>
    }

    @Override
    public EntityRef create(Prefab prefab) {
<span class="fc" id="L231">        return getCurrentWorldPool().create(prefab);</span>
    }

    @Override
    //Todo: Depreciated, maybe remove? Not many uses
    public EntityRef copy(EntityRef other) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (!other.exists()) {</span>
<span class="nc" id="L238">            return EntityRef.NULL;</span>
        }
<span class="nc" id="L240">        List&lt;Component&gt; newEntityComponents = Lists.newArrayList();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        for (Component c : other.iterateComponents()) {</span>
<span class="nc" id="L242">            newEntityComponents.add(componentLibrary.copy(c));</span>
<span class="nc" id="L243">        }</span>
<span class="nc" id="L244">        return getCurrentWorldPool().create(newEntityComponents);</span>
    }

    @Override
    public Map&lt;Class&lt;? extends Component&gt;, Component&gt; copyComponents(EntityRef other) {
<span class="fc" id="L249">        Map&lt;Class&lt;? extends Component&gt;, Component&gt; result = Maps.newHashMap();</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">        for (Component c : other.iterateComponents()) {</span>
<span class="fc" id="L251">            result.put(c.getClass(), componentLibrary.copy(c));</span>
<span class="fc" id="L252">        }</span>
<span class="fc" id="L253">        return result;</span>
    }

    @Override
    public Iterable&lt;EntityRef&gt; getAllEntities() {
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">        if (isWorldPoolGlobalPool()) {</span>
<span class="fc" id="L259">            return Iterables.concat(globalPool.getAllEntities(), sectorManager.getAllEntities());</span>
        }
<span class="nc" id="L261">        return Iterables.concat(globalPool.getAllEntities(), getCurrentWorldPool().getAllEntities(), sectorManager.getAllEntities());</span>
    }

    @SafeVarargs
    @Override
    public final Iterable&lt;EntityRef&gt; getEntitiesWith(Class&lt;? extends Component&gt;... componentClasses) {
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">        if (isWorldPoolGlobalPool()) {</span>
<span class="fc" id="L268">            return Iterables.concat(globalPool.getEntitiesWith(componentClasses),</span>
<span class="fc" id="L269">                    sectorManager.getEntitiesWith(componentClasses));</span>
        }
<span class="nc" id="L271">        return Iterables.concat(globalPool.getEntitiesWith(componentClasses),</span>
<span class="nc" id="L272">                getCurrentWorldPool().getEntitiesWith(componentClasses), sectorManager.getEntitiesWith(componentClasses));</span>
    }

    @Override
    public int getActiveEntityCount() {
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (isWorldPoolGlobalPool()) {</span>
<span class="nc" id="L278">            return globalPool.getActiveEntityCount() + sectorManager.getActiveEntityCount();</span>
        }
<span class="nc" id="L280">        return globalPool.getActiveEntityCount() + getCurrentWorldPool().getActiveEntityCount()</span>
<span class="nc" id="L281">                + sectorManager.getActiveEntityCount();</span>

    }

    @Override
    public ComponentLibrary getComponentLibrary() {
<span class="fc" id="L287">        return componentLibrary;</span>
    }

    public void setComponentLibrary(ComponentLibrary componentLibrary) {
<span class="fc" id="L291">        this.componentLibrary = componentLibrary;</span>
<span class="fc" id="L292">    }</span>

    @Override
    public EventSystem getEventSystem() {
<span class="fc" id="L296">        return eventSystem;</span>
    }

    @Override
    public void setEventSystem(EventSystem eventSystem) {
<span class="fc" id="L301">        this.eventSystem = eventSystem;</span>
<span class="fc" id="L302">    }</span>

    @Override
    public PrefabManager getPrefabManager() {
<span class="fc" id="L306">        return prefabManager;</span>
    }

    public void setPrefabManager(PrefabManager prefabManager) {
<span class="fc" id="L310">        this.prefabManager = prefabManager;</span>
<span class="fc" id="L311">    }</span>


    /*
     * Engine features
     */

    @Override
    public EntityRef getEntity(long id) {
<span class="fc" id="L320">        return getPool(id)</span>
<span class="fc" id="L321">                .map(pool -&gt; pool.getEntity(id))</span>
<span class="fc" id="L322">                .orElse(EntityRef.NULL);</span>
    }

    @Override
    public List&lt;EngineEntityPool&gt; getWorldPools() {
<span class="nc" id="L327">        return worldPools;</span>
    }

    @Override
    public Map&lt;WorldInfo, EngineEntityPool&gt; getWorldPoolsMap() {
<span class="nc" id="L332">        return worldManager.getWorldPoolMap();</span>
    }

    @Override
    public Map&lt;Long, EngineEntityPool&gt; getPoolMap() {
<span class="nc" id="L337">        return poolMap;</span>
    }

    @Override
    public Map&lt;EngineEntityPool, Long&gt; getPoolCounts() {
<span class="nc" id="L342">        return poolCounts;</span>
    }

    /**
     * Creates the entity without sending any events. The entity life cycle subscriber will however be informed.
     */
    @Override
    public EntityRef createEntityWithoutLifecycleEvents(Iterable&lt;Component&gt; components) {
<span class="nc" id="L350">        return getCurrentWorldPool().createEntityWithoutLifecycleEvents(components);</span>
    }

    /**
     * Creates the entity without sending any events. The entity life cycle subscriber will however be informed.
     */
    @Override
    public EntityRef createEntityWithoutLifecycleEvents(String prefabName) {
<span class="nc" id="L358">        return getCurrentWorldPool().createEntityWithoutLifecycleEvents(prefabName);</span>
    }

    /**
     * Creates the entity without sending any events. The entity life cycle subscriber will however be informed.
     */
    @Override
    public EntityRef createEntityWithoutLifecycleEvents(Prefab prefab) {
<span class="nc" id="L366">        return getCurrentWorldPool().createEntityWithoutLifecycleEvents(prefab);</span>
    }

    @Override
    public void putEntity(long entityId, BaseEntityRef ref) {
<span class="nc" id="L371">        getCurrentWorldPool().putEntity(entityId, ref);</span>
<span class="nc" id="L372">    }</span>

    @Override
    public ComponentTable getComponentStore() {
<span class="fc" id="L376">        return getCurrentWorldPool().getComponentStore();</span>
    }

    @Override
    public void destroyEntityWithoutEvents(EntityRef entity) {
<span class="fc" id="L381">        getCurrentWorldPool().destroyEntityWithoutEvents(entity);</span>
<span class="fc" id="L382">    }</span>

    @Override
    public EntityRef createEntityWithId(long id, Iterable&lt;Component&gt; components) {
<span class="fc" id="L386">        EntityBuilder builder = newBuilder();</span>
<span class="fc" id="L387">        builder.setId(id);</span>
<span class="fc" id="L388">        builder.addComponents(components);</span>
<span class="fc" id="L389">        return builder.build();</span>
    }

    @Override
    public void subscribeForChanges(EntityChangeSubscriber subscriber) {
<span class="fc" id="L394">        subscribers.add(subscriber);</span>
<span class="fc" id="L395">    }</span>

    @Override
    public void subscribeForDestruction(EntityDestroySubscriber subscriber) {
<span class="fc" id="L399">        destroySubscribers.add(subscriber);</span>
<span class="fc" id="L400">    }</span>

    @Override
    public void unsubscribe(EntityChangeSubscriber subscriber) {
<span class="fc" id="L404">        subscribers.remove(subscriber);</span>
<span class="fc" id="L405">    }</span>

    @Override
    public TypeHandlerLibrary getTypeSerializerLibrary() {
<span class="fc" id="L409">        return typeSerializerLibrary;</span>
    }

    public void setTypeSerializerLibrary(TypeHandlerLibrary serializerLibrary) {
<span class="fc" id="L413">        this.typeSerializerLibrary = serializerLibrary;</span>
<span class="fc" id="L414">    }</span>

    @Override
    public EngineSectorManager getSectorManager() {
<span class="fc" id="L418">        return sectorManager;</span>
    }

    @Override
    public void deactivateForStorage(EntityRef entity) {
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">        if (!entity.exists()) {</span>
<span class="nc" id="L424">            return;</span>
        }

<span class="fc" id="L427">        long entityId = entity.getId();</span>
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">        if (eventSystem != null) {</span>
<span class="fc" id="L429">            eventSystem.send(entity, BeforeDeactivateComponent.newInstance());</span>
        }

<span class="fc" id="L432">        List&lt;Component&gt; components = Collections.unmodifiableList(</span>
<span class="fc" id="L433">                getPool(entityId)</span>
<span class="fc" id="L434">                        .map(pool -&gt; pool.getComponentStore().getComponentsInNewList(entityId))</span>
<span class="fc" id="L435">                        .orElse(Collections.emptyList()));</span>

<span class="fc" id="L437">        notifyBeforeDeactivation(entity, components);</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">        for (Component component : components) {</span>
<span class="fc" id="L439">            getPool(entityId).ifPresent(pool -&gt; pool.getComponentStore().remove(entityId, component.getClass()));</span>
<span class="fc" id="L440">        }</span>
<span class="fc" id="L441">        loadedIds.remove(entityId);</span>
<span class="fc" id="L442">    }</span>

    @Override
    public long getNextId() {
<span class="fc" id="L446">        return nextEntityId;</span>
    }

    @Override
    public void setNextId(long id) {
<span class="fc" id="L451">        nextEntityId = id;</span>
<span class="fc" id="L452">    }</span>


    /*
     * For use by Entity Refs
     */

    /**
     * @param entityId
     * @param componentClass
     * @return Whether the entity has a component of the given type
     */
    @Override
    public boolean hasComponent(long entityId, Class&lt;? extends Component&gt; componentClass) {
<span class="fc bfc" id="L466" title="All 2 branches covered.">        return globalPool.getComponentStore().get(entityId, componentClass) != null</span>
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">                || getCurrentWorldPool().getComponentStore().get(entityId, componentClass) != null</span>
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">                || sectorManager.hasComponent(entityId, componentClass);</span>
    }

    @Override
    public boolean isExistingEntity(long id) {
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">        return nextEntityId &gt; id;</span>
    }

    /**
     * @param id
     * @return Whether the entity is currently active
     */
    @Override
    public boolean isActiveEntity(long id) {
<span class="fc" id="L482">        return loadedIds.contains(id);</span>
    }

    /**
     * @param entityId
     * @return An iterable over the components of the given entity
     */
    @Override
    public Iterable&lt;Component&gt; iterateComponents(long entityId) {
<span class="fc" id="L491">        return getPool(entityId)</span>
<span class="fc" id="L492">                .map(pool -&gt; pool.getComponentStore().iterateComponents(entityId))</span>
<span class="fc" id="L493">                .orElse(Collections.emptyList());</span>
    }

    @Override
    public void destroy(long entityId) {
<span class="fc" id="L498">        getPool(entityId).ifPresent(pool -&gt; pool.destroy(entityId));</span>
<span class="fc" id="L499">    }</span>

    protected void notifyComponentRemovalAndEntityDestruction(long entityId, EntityRef ref) {
<span class="fc" id="L502">        getPool(entityId)</span>
<span class="fc" id="L503">                .map(pool -&gt; pool.getComponentStore().iterateComponents(entityId))</span>
<span class="fc" id="L504">                .orElse(Collections.emptyList())</span>
<span class="fc" id="L505">                .forEach(comp -&gt; notifyComponentRemoved(ref, comp.getClass()));</span>

<span class="fc bfc" id="L507" title="All 2 branches covered.">        for (EntityDestroySubscriber destroySubscriber : destroySubscribers) {</span>
<span class="fc" id="L508">            destroySubscriber.onEntityDestroyed(ref);</span>
<span class="fc" id="L509">        }</span>
<span class="fc" id="L510">    }</span>

    /**
     * @param entityId
     * @param componentClass
     * @param &lt;T&gt;
     * @return The component of that type owned by the given entity, or null if it doesn't have that component
     */
    @Override
    public &lt;T extends Component&gt; T getComponent(long entityId, Class&lt;T&gt; componentClass) {
<span class="fc" id="L520">        return getPool(entityId)</span>
<span class="fc" id="L521">                .map(pool -&gt; pool.getComponentStore().get(entityId, componentClass))</span>
<span class="fc" id="L522">                .orElse(null);</span>
    }

    /**
     * Adds (or replaces) a component to an entity
     *
     * @param entityId
     * @param component
     * @param &lt;T&gt;
     * @return The added component
     */
    @Override
    public &lt;T extends Component&gt; T addComponent(long entityId, T component) {
<span class="fc" id="L535">        Preconditions.checkNotNull(component);</span>
<span class="fc" id="L536">        Optional&lt;Component&gt; oldComponent = getPool(entityId).map(pool -&gt; pool.getComponentStore().put(entityId, component));</span>

<span class="fc bfc" id="L538" title="All 2 branches covered.">        if (!oldComponent.isPresent()) {</span>
<span class="fc" id="L539">            notifyComponentAdded(getEntity(entityId), component.getClass());</span>
        } else {
<span class="fc" id="L541">            logger.error(&quot;Adding a component ({}) over an existing component for entity {}&quot;, component.getClass(), entityId);</span>
<span class="fc" id="L542">            notifyComponentChanged(getEntity(entityId), component.getClass());</span>
        }
<span class="fc bfc" id="L544" title="All 2 branches covered.">        if (eventSystem != null) {</span>
<span class="fc" id="L545">            EntityRef entityRef = getEntity(entityId);</span>
<span class="fc bfc" id="L546" title="All 2 branches covered.">            if (!oldComponent.isPresent()) {</span>
<span class="fc" id="L547">                eventSystem.send(entityRef, OnAddedComponent.newInstance(), component);</span>
<span class="fc" id="L548">                eventSystem.send(entityRef, OnActivatedComponent.newInstance(), component);</span>
            } else {
<span class="fc" id="L550">                eventSystem.send(entityRef, OnChangedComponent.newInstance(), component);</span>
            }
        }
<span class="fc" id="L553">        return component;</span>
    }

    /**
     * Removes a component from an entity
     *
     * @param entityId
     * @param componentClass
     */
    @Override
    public &lt;T extends Component&gt; T removeComponent(long entityId, Class&lt;T&gt; componentClass) {
<span class="fc" id="L564">        Optional&lt;ComponentTable&gt; maybeStore = getPool(entityId).map(EngineEntityPool::getComponentStore);</span>
<span class="fc" id="L565">        Optional&lt;T&gt; component = maybeStore.map(store -&gt; store.get(entityId, componentClass));</span>

<span class="fc bfc" id="L567" title="All 2 branches covered.">        if (component.isPresent()) {</span>
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">            if (eventSystem != null) {</span>
<span class="fc" id="L569">                EntityRef entityRef = getEntity(entityId);</span>
<span class="fc" id="L570">                eventSystem.send(entityRef, BeforeDeactivateComponent.newInstance(), component.get());</span>
<span class="fc" id="L571">                eventSystem.send(entityRef, BeforeRemoveComponent.newInstance(), component.get());</span>
            }
<span class="fc" id="L573">            notifyComponentRemoved(getEntity(entityId), componentClass);</span>
<span class="fc" id="L574">            maybeStore.ifPresent(store -&gt; store.remove(entityId, componentClass));</span>
        }
<span class="fc" id="L576">        return component.orElse(null);</span>
    }

    /**
     * Saves a component to an entity
     *
     * @param entityId
     * @param component
     */
    @Override
    public void saveComponent(long entityId, Component component) {
<span class="fc" id="L587">        Optional&lt;Component&gt; oldComponent = getPool(entityId)</span>
<span class="fc" id="L588">                .map(pool -&gt; pool.getComponentStore().put(entityId, component));</span>

<span class="pc bpc" id="L590" title="1 of 2 branches missed.">        if (!oldComponent.isPresent()) {</span>
<span class="nc" id="L591">            logger.error(&quot;Saving a component ({}) that doesn't belong to this entity {}&quot;, component.getClass(), entityId);</span>
        }
<span class="pc bpc" id="L593" title="1 of 2 branches missed.">        if (eventSystem != null) {</span>
<span class="fc" id="L594">            EntityRef entityRef = getEntity(entityId);</span>
<span class="pc bpc" id="L595" title="1 of 2 branches missed.">            if (!oldComponent.isPresent()) {</span>
<span class="nc" id="L596">                eventSystem.send(entityRef, OnAddedComponent.newInstance(), component);</span>
<span class="nc" id="L597">                eventSystem.send(entityRef, OnActivatedComponent.newInstance(), component);</span>
            } else {
<span class="fc" id="L599">                eventSystem.send(entityRef, OnChangedComponent.newInstance(), component);</span>
            }
        }
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">        if (!oldComponent.isPresent()) {</span>
<span class="nc" id="L603">            notifyComponentAdded(getEntity(entityId), component.getClass());</span>
        } else {
<span class="fc" id="L605">            notifyComponentChanged(getEntity(entityId), component.getClass());</span>
        }
<span class="fc" id="L607">    }</span>


    /*
     * Implementation
     */

    public Optional&lt;EngineEntityPool&gt; getPool(long id) {
<span class="fc" id="L615">        Optional&lt;EngineEntityPool&gt; pool = Optional.ofNullable(poolMap.get(id));</span>
<span class="fc bfc" id="L616" title="All 2 branches covered.">        if (!pool.isPresent()) {</span>
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">            if (id != NULL_ID) {</span>
<span class="pc bpc" id="L618" title="1 of 2 branches missed.">                if (isExistingEntity(id)) {</span>
                    // TODO: Entity pools assignment is not needed as of now, can be enabled later on when necessary.
                    // logger.error(&quot;Entity {} doesn't have an assigned pool&quot;, id);
                } else {
<span class="nc" id="L622">                    logger.error(&quot;Entity {} doesn't exist&quot;, id);</span>
                }
            }
        }
<span class="fc" id="L626">        return pool;</span>
    }

    /**
     * Assign the given entity to the given pool.
     * &lt;p&gt;
     * If the entity is already assigned to a pool, it will be re-assigned to the given pool.
     * This does not actually move the entity or any of its components.
     * If you want to move an entity to a different pool, {@link #moveToPool(long, EngineEntityPool)} should be used
     * instead.
     *
     * @param entityId the id of the entity to assign
     * @param pool     the pool to assign the entity to
     */
    @Override
    public void assignToPool(long entityId, EngineEntityPool pool) {
<span class="fc bfc" id="L642" title="All 2 branches covered.">        if (poolMap.get(entityId) != pool) {</span>
<span class="fc" id="L643">            poolMap.put(entityId, pool);</span>
<span class="fc bfc" id="L644" title="All 2 branches covered.">            if (!poolCounts.containsKey(pool)) {</span>
<span class="fc" id="L645">                poolCounts.put(pool, 1L);</span>
            } else {
<span class="fc" id="L647">                poolCounts.put(pool, poolCounts.get(pool) + 1L);</span>
            }
        }
<span class="fc" id="L650">    }</span>

    /**
     * Remove the assignment of an entity to a pool.
     * &lt;p&gt;
     * This does not affect anything else related to the entity, but may lead to the entity or its components being
     * unable to be found.
     * &lt;p&gt;
     * When using this method, be sure to properly re-assign the entity to its correct pool afterwards.
     *
     * @param id the id of the entity to remove the assignment for
     */
    protected void unassignPool(long id) {
<span class="fc" id="L663">        poolMap.remove(id);</span>
<span class="fc" id="L664">    }</span>

    @Override
    public boolean moveToPool(long id, EngineEntityPool pool) {

<span class="pc bpc" id="L669" title="1 of 4 branches missed.">        if (getPool(id).isPresent() &amp;&amp; getPool(id).get().equals(pool)) {</span>
            //The entity is already in the correct pool
<span class="fc" id="L671">            return true;</span>
        }

        //Save the current entity and components
<span class="fc" id="L675">        Optional&lt;EngineEntityPool&gt; maybePool = getPool(id);</span>
        EngineEntityPool oldPool;
<span class="pc bpc" id="L677" title="1 of 2 branches missed.">        if (!maybePool.isPresent()) {</span>
<span class="nc" id="L678">            return false;</span>
        } else {
<span class="fc" id="L680">            oldPool = maybePool.get();</span>
        }
<span class="fc" id="L682">        Map&lt;Class&lt;? extends Component&gt;, Component&gt; savedComponents = copyComponents(oldPool.getEntity(id));</span>

        //Remove from the existing pool
<span class="fc" id="L685">        Optional&lt;BaseEntityRef&gt; maybeRef = oldPool.remove(id);</span>
        //Decrease the count of entities in that pool
<span class="fc" id="L687">        poolCounts.put(oldPool, poolCounts.get(oldPool) - 1);</span>
<span class="pc bpc" id="L688" title="1 of 2 branches missed.">        if (!maybeRef.isPresent()) {</span>
<span class="nc" id="L689">            return false;</span>
        }
<span class="fc" id="L691">        BaseEntityRef ref = maybeRef.get();</span>

        //Create in new pool
<span class="fc" id="L694">        pool.insertRef(ref, savedComponents.values());</span>

        //TODO: send events?

<span class="fc" id="L698">        return true;</span>
    }

    @Override
    public void notifyComponentAdded(EntityRef changedEntity, Class&lt;? extends Component&gt; component) {
<span class="fc bfc" id="L703" title="All 2 branches covered.">        for (EntityChangeSubscriber subscriber : subscribers) {</span>
<span class="fc" id="L704">            subscriber.onEntityComponentAdded(changedEntity, component);</span>
<span class="fc" id="L705">        }</span>
<span class="fc" id="L706">    }</span>

    protected void notifyComponentRemoved(EntityRef changedEntity, Class&lt;? extends Component&gt; component) {
<span class="fc bfc" id="L709" title="All 2 branches covered.">        for (EntityChangeSubscriber subscriber : subscribers) {</span>
<span class="fc" id="L710">            subscriber.onEntityComponentRemoved(changedEntity, component);</span>
<span class="fc" id="L711">        }</span>
<span class="fc" id="L712">    }</span>

    protected void notifyComponentChanged(EntityRef changedEntity, Class&lt;? extends Component&gt; component) {
<span class="fc bfc" id="L715" title="All 2 branches covered.">        for (EntityChangeSubscriber subscriber : subscribers) {</span>
<span class="fc" id="L716">            subscriber.onEntityComponentChange(changedEntity, component);</span>
<span class="fc" id="L717">        }</span>
<span class="fc" id="L718">    }</span>

    /**
     * This method gets called when the entity gets reactivated. e.g. after storage an entity needs to be reactivated.
     */
    private void notifyReactivation(EntityRef entity, Collection&lt;Component&gt; components) {
<span class="nc bnc" id="L724" title="All 2 branches missed.">        for (EntityChangeSubscriber subscriber : subscribers) {</span>
<span class="nc" id="L725">            subscriber.onReactivation(entity, components);</span>
<span class="nc" id="L726">        }</span>
<span class="nc" id="L727">    }</span>


    /**
     * This method gets called before an entity gets deactivated (e.g. for storage).
     */
    private void notifyBeforeDeactivation(EntityRef entity, Collection&lt;Component&gt; components) {
<span class="pc bpc" id="L734" title="1 of 2 branches missed.">        for (EntityChangeSubscriber subscriber : subscribers) {</span>
<span class="nc" id="L735">            subscriber.onBeforeDeactivation(entity, components);</span>
<span class="nc" id="L736">        }</span>
<span class="fc" id="L737">    }</span>

    @Override
    @SafeVarargs
    public final int getCountOfEntitiesWith(Class&lt;? extends Component&gt;... componentClasses) {
<span class="pc bpc" id="L742" title="1 of 2 branches missed.">        if (isWorldPoolGlobalPool()) {</span>
<span class="fc" id="L743">            return globalPool.getCountOfEntitiesWith(componentClasses) +</span>
<span class="fc" id="L744">                    sectorManager.getCountOfEntitiesWith(componentClasses);</span>
        }
<span class="nc" id="L746">        return sectorManager.getCountOfEntitiesWith(componentClasses) +</span>
<span class="nc" id="L747">                getCurrentWorldPool().getCountOfEntitiesWith(componentClasses) +</span>
<span class="nc" id="L748">                globalPool.getCountOfEntitiesWith(componentClasses);</span>
    }

    public &lt;T extends Component&gt; Iterable&lt;Map.Entry&lt;EntityRef, T&gt;&gt; listComponents(Class&lt;T&gt; componentClass) {
<span class="fc" id="L752">        List&lt;TLongObjectIterator&lt;T&gt;&gt; iterators = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L753" title="1 of 2 branches missed.">        if (isWorldPoolGlobalPool()) {</span>
<span class="fc" id="L754">            iterators.add(globalPool.getComponentStore().componentIterator(componentClass));</span>
        } else {
<span class="nc" id="L756">            iterators.add(globalPool.getComponentStore().componentIterator(componentClass));</span>
<span class="nc" id="L757">            iterators.add(getCurrentWorldPool().getComponentStore().componentIterator(componentClass));</span>
        }
<span class="fc" id="L759">        iterators.add(sectorManager.getComponentStore().componentIterator(componentClass));</span>

<span class="fc" id="L761">        List&lt;Map.Entry&lt;EntityRef, T&gt;&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L762" title="All 2 branches covered.">        for (TLongObjectIterator&lt;T&gt; iterator : iterators) {</span>
<span class="fc bfc" id="L763" title="All 2 branches covered.">            if (iterator != null) {</span>
<span class="fc bfc" id="L764" title="All 2 branches covered.">                while (iterator.hasNext()) {</span>
<span class="fc" id="L765">                    iterator.advance();</span>
<span class="fc" id="L766">                    list.add(new EntityEntry&lt;&gt;(getEntity(iterator.key()), iterator.value()));</span>
                }
            }
<span class="fc" id="L769">        }</span>
<span class="fc" id="L770">        return list;</span>
    }

    @Override
    public boolean registerId(long entityId) {
<span class="pc bpc" id="L775" title="1 of 2 branches missed.">        if (entityId &gt;= nextEntityId) {</span>
<span class="nc" id="L776">            logger.error(&quot;Prevented attempt to create entity with an invalid id.&quot;);</span>
<span class="nc" id="L777">            return false;</span>
        }
<span class="fc" id="L779">        loadedIds.add(entityId);</span>
<span class="fc" id="L780">        return true;</span>
    }

    protected boolean idLoaded(long entityId) {
<span class="fc" id="L784">        return loadedIds.contains(entityId);</span>
    }

    @Override
    public Optional&lt;BaseEntityRef&gt; remove(long id) {
<span class="nc" id="L789">        return getPool(id)</span>
<span class="nc" id="L790">                .flatMap(pool -&gt; pool.remove(id));</span>
    }

    @Override
    public void insertRef(BaseEntityRef ref, Iterable&lt;Component&gt; components) {
<span class="nc" id="L795">        globalPool.insertRef(ref, components);</span>
<span class="nc" id="L796">    }</span>

    @Override
    public boolean contains(long id) {
<span class="nc bnc" id="L800" title="All 4 branches missed.">        return globalPool.contains(id) || sectorManager.contains(id);</span>
    }

    /**
     * Remove this id from the entity manager's list of loaded ids.
     *
     * @param id the id to remove
     */
    protected void unregister(long id) {
<span class="fc" id="L809">        loadedIds.remove(id);</span>
<span class="fc" id="L810">    }</span>

    private static class EntityEntry&lt;T&gt; implements Map.Entry&lt;EntityRef, T&gt; {
        private EntityRef key;
        private T value;

<span class="fc" id="L816">        EntityEntry(EntityRef ref, T value) {</span>
<span class="fc" id="L817">            this.key = ref;</span>
<span class="fc" id="L818">            this.value = value;</span>
<span class="fc" id="L819">        }</span>

        @Override
        public EntityRef getKey() {
<span class="fc" id="L823">            return key;</span>
        }

        @Override
        public T getValue() {
<span class="fc" id="L828">            return value;</span>
        }

        @Override
        public T setValue(T newValue) {
<span class="nc" id="L833">            throw new UnsupportedOperationException();</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>